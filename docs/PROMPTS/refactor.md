Refactor for clarity/testability without changing behavior. Extract pure functions, improve names, and add small unit tests. Return only a minimal diff and tests.
